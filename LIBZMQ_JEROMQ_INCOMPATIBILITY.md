# libzmq 4.3.5 / JeroMQ 0.6.0 Incompatibility Analysis

## Summary

**Issue:** TypeScript client (using zeromq.js with libzmq 4.3.5) cannot establish a stable connection to Scala server (using JeroMQ 0.6.0). The connection establishes at TCP level but immediately disconnects at ZMTP protocol level.

**Root Cause:** Protocol-level incompatibility between libzmq 4.3.5 and JeroMQ 0.6.0 (which is based on libzmq 4.1.7).

## Symptoms

1. DEALER socket connects successfully (TCP connection established)
2. Connection immediately disconnects (< 1 second)
3. Server ROUTER socket only receives auto-generated `ConnectionClosed` message (7 bytes)
4. Actual application messages (e.g., `CreateSession`) never reach the server
5. Issue occurs whether or not messages are sent

## Investigation Steps

### Version Information
- **Client:** zeromq.js 6.5.0 → libzmq 4.3.5  
- **Server:** JeroMQ 0.6.0 (based on libzmq 4.1.7)
- **Protocol:** ZMTP/3.0

### Configuration Attempts (All Failed)

1. **Heartbeat Configuration**
   - ✗ With heartbeat (1000/10000/30000)
   - ✗ Without heartbeat
   - ✗ Various heartbeat intervals

2. **Socket Options**
   - ✗ `immediate: true` 
   - ✗ `immediate: false`
   - ✗ `probeRouter: true`
   - ✗ `handshakeInterval: 0` (disable timeout)
   - ✗ `linger: 0`

3. **Timing and Delays**
   - ✗ 500ms delay after connect
   - ✗ Sending before connect event
   - ✗ Sending after connect event  
   - ✗ Not sending any message at all

4. **Version Upgrades**
   - ✗ JeroMQ 0.5.3 → 0.6.0 (no improvement)

### Test Results

```
Test: Connect without sending any message
Result: Still disconnects immediately
Conclusion: Issue is not related to application messages
```

```
Test: All socket option combinations
Result: All result in immediate disconnect
Conclusion: Configuration cannot resolve this issue
```

### Server Log Evidence

```
timestamp=... level=DEBUG message="[incomingMessages] Received message: #zmq.Msg{type=DATA, size=7, flags=0}"
timestamp=... level=DEBUG message="Received client message: ConnectionClosed at routingId: ..."
```

The server only ever receives the 7-byte `ConnectionClosed` message, which is auto-generated by JeroMQ's `setDisconnectMessage()` option when a peer disconnects.

## Technical Analysis

### Why This Happens

1. **Protocol Base Mismatch**
   - JeroMQ 0.6.0 is based on libzmq 4.1.7
   - Client uses libzmq 4.3.5
   - ZMTP handshake differences between these versions cause rejection

2. **Known Issues**
   - libzmq 4.3.3+ has documented handshake issues with older ZMQ implementations
   - JeroMQ 0.6.0 release notes confirm it's based on older libzmq 4.1.7
   - Protocol negotiation fails silently at ZMTP level

3. **Why It's Not Application-Level**
   - Disconnect occurs even with NO messages sent
   - Disconnect occurs BEFORE any application data transmission
   - TCP connection succeeds, but ZMTP handshake fails

## References

- [libzmq Issue #4147](https://github.com/zeromq/libzmq/issues/4147) - Handshake hang after 30 seconds
- [JeroMQ GitHub](https://github.com/zeromq/jeromq) - Based on libzmq 4.1.7
- [zeromq.js](https://github.com/zeromq/zeromq.js) - Uses libzmq 4.3.5

## Recommended Solutions

### Option 1: Use Native libzmq on Server (Recommended)
Replace JeroMQ with JNI bindings to native libzmq 4.3.x:
- Use jzmq or zeromq-jni
- Ensures protocol compatibility
- Matches client's libzmq version

### Option 2: Alternative Transport Layer
Implement HTTP/WebSocket transport alongside ZMQ:
- Add HTTP endpoints for TypeScript clients
- Keep ZMQ for Scala-to-Scala communication
- More maintenance overhead

### Option 3: ZMQ Proxy Bridge
Run a libzmq proxy between client and server:
- Proxy uses libzmq 4.3.5 (matches client)
- Bridges to JeroMQ server
- Additional infrastructure complexity

### Option 4: Downgrade Client (Not Recommended)
Try older zeromq.js version with libzmq 4.1.x:
- May introduce other compatibility issues
- Loses modern features
- Not guaranteed to work

## Conclusion

This is a **fundamental protocol incompatibility** that cannot be resolved through configuration changes. The only viable solution is to either:
1. Replace JeroMQ with native libzmq on the server
2. Implement an alternative transport layer for cross-language communication

The issue is well-documented in the ZeroMQ ecosystem and affects communication between different libzmq major/minor versions.
